

const jsonQuery =
{
  "query": [
    {
      "code": "Vuosi",
      "selection": {
        "filter": "item",
        "values": [
          "1990", "1991", "1992", "1993", "1994", "1995", 
          "1996", "1997", "1998", "1999", "2000", "2001", 
          "2002", "2003", "2004", "2005", "2006", "2007", 
          "2008", "2009", "2010", "2011", "2012", "2013", 
          "2014", "2015", "2016", "2017", "2018", "2019", 
          "2020", "2021", "2022", "2023", "2024"
        ]
      }
    },
    {
      "code": "Alue",
      "selection": {
        "filter": "item",
        "values": [
          "SSS",
          "KU020",
          "KU005",
          "KU009",
          "KU010",
          "KU016",
          "KU018",
          "KU019",
          "KU035",
          "KU043",
          "KU046",
          "KU047",
          "KU049",
          "KU050",
          "KU051",
          "KU052",
          "KU060",
          "KU061",
          "KU062",
          "KU065",
          "KU069",
          "KU071",
          "KU072",
          "KU074",
          "KU075",
          "KU076",
          "KU077",
          "KU078",
          "KU079",
          "KU081",
          "KU082",
          "KU086",
          "KU111",
          "KU090",
          "KU091",
          "KU097",
          "KU098",
          "KU102",
          "KU103",
          "KU105",
          "KU106",
          "KU108",
          "KU109",
          "KU139",
          "KU140",
          "KU142",
          "KU143",
          "KU145",
          "KU146",
          "KU153",
          "KU148",
          "KU149",
          "KU151",
          "KU152",
          "KU165",
          "KU167",
          "KU169",
          "KU170",
          "KU171",
          "KU172",
          "KU176",
          "KU177",
          "KU178",
          "KU179",
          "KU181",
          "KU182",
          "KU186",
          "KU202",
          "KU204",
          "KU205",
          "KU208",
          "KU211",
          "KU213",
          "KU214",
          "KU216",
          "KU217",
          "KU218",
          "KU224",
          "KU226",
          "KU230",
          "KU231",
          "KU232",
          "KU233",
          "KU235",
          "KU236",
          "KU239",
          "KU240",
          "KU320",
          "KU241",
          "KU322",
          "KU244",
          "KU245",
          "KU249",
          "KU250",
          "KU256",
          "KU257",
          "KU260",
          "KU261",
          "KU263",
          "KU265",
          "KU271",
          "KU272",
          "KU273",
          "KU275",
          "KU276",
          "KU280",
          "KU284",
          "KU285",
          "KU286",
          "KU287",
          "KU288",
          "KU290",
          "KU291",
          "KU295",
          "KU297",
          "KU300",
          "KU301",
          "KU304",
          "KU305",
          "KU312",
          "KU316",
          "KU317",
          "KU318",
          "KU398",
          "KU399",
          "KU400",
          "KU407",
          "KU402",
          "KU403",
          "KU405",
          "KU408",
          "KU410",
          "KU416",
          "KU417",
          "KU418",
          "KU420",
          "KU421",
          "KU422",
          "KU423",
          "KU425",
          "KU426",
          "KU444",
          "KU430",
          "KU433",
          "KU434",
          "KU435",
          "KU436",
          "KU438",
          "KU440",
          "KU441",
          "KU475",
          "KU478",
          "KU480",
          "KU481",
          "KU483",
          "KU484",
          "KU489",
          "KU491",
          "KU494",
          "KU495",
          "KU498",
          "KU499",
          "KU500",
          "KU503",
          "KU504",
          "KU505",
          "KU508",
          "KU507",
          "KU529",
          "KU531",
          "KU535",
          "KU536",
          "KU538",
          "KU541",
          "KU543",
          "KU545",
          "KU560",
          "KU561",
          "KU562",
          "KU563",
          "KU564",
          "KU309",
          "KU576",
          "KU577",
          "KU578",
          "KU445",
          "KU580",
          "KU581",
          "KU599",
          "KU583",
          "KU854",
          "KU584",
          "KU592",
          "KU593",
          "KU595",
          "KU598",
          "KU601",
          "KU604",
          "KU607",
          "KU608",
          "KU609",
          "KU611",
          "KU638",
          "KU614",
          "KU615",
          "KU616",
          "KU619",
          "KU620",
          "KU623",
          "KU624",
          "KU625",
          "KU626",
          "KU630",
          "KU631",
          "KU635",
          "KU636",
          "KU678",
          "KU710",
          "KU680",
          "KU681",
          "KU683",
          "KU684",
          "KU686",
          "KU687",
          "KU689",
          "KU691",
          "KU694",
          "KU697",
          "KU698",
          "KU700",
          "KU702",
          "KU704",
          "KU707",
          "KU729",
          "KU732",
          "KU734",
          "KU736",
          "KU790",
          "KU738",
          "KU739",
          "KU740",
          "KU742",
          "KU743",
          "KU746",
          "KU747",
          "KU748",
          "KU791",
          "KU749",
          "KU751",
          "KU753",
          "KU755",
          "KU758",
          "KU759",
          "KU761",
          "KU762",
          "KU765",
          "KU766",
          "KU768",
          "KU771",
          "KU777",
          "KU778",
          "KU781",
          "KU783",
          "KU831",
          "KU832",
          "KU833",
          "KU834",
          "KU837",
          "KU844",
          "KU845",
          "KU846",
          "KU848",
          "KU849",
          "KU850",
          "KU851",
          "KU853",
          "KU857",
          "KU858",
          "KU859",
          "KU886",
          "KU887",
          "KU889",
          "KU890",
          "KU892",
          "KU893",
          "KU895",
          "KU785",
          "KU905",
          "KU908",
          "KU092",
          "KU915",
          "KU918",
          "KU921",
          "KU922",
          "KU924",
          "KU925",
          "KU927",
          "KU931",
          "KU934",
          "KU935",
          "KU936",
          "KU941",
          "KU946",
          "KU976",
          "KU977",
          "KU980",
          "KU981",
          "KU989",
          "KU992"
        ]
      }
    },
    {
      "code": "Tiedot",
      "selection": {
        "filter": "item",
        "values": [
            "vm01",     // Live births
            "vm11",     // Deaths
            "vm41",     // Immigration to Finland
            "vm42",     // Emigration from Finland
            "vm4142",   // Net migration (immigration minus emigration)
            "vm2126",   // Marriages 
            "vm3136",   // Divorces
            "vaesto"    // Total population
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat2"
  }
}

const jsonQuery2 = 
{
  "query": [
    {
      "code": "Alue",
      "selection": {
        "filter": "item",
        "values": [
          "SSS",
          "KU020",
          "KU005",
          "KU009",
          "KU010",
          "KU016",
          "KU018",
          "KU019",
          "KU035",
          "KU043",
          "KU046",
          "KU047",
          "KU049",
          "KU050",
          "KU051",
          "KU052",
          "KU060",
          "KU061",
          "KU062",
          "KU065",
          "KU069",
          "KU071",
          "KU072",
          "KU074",
          "KU075",
          "KU076",
          "KU077",
          "KU078",
          "KU079",
          "KU081",
          "KU082",
          "KU086",
          "KU111",
          "KU090",
          "KU091",
          "KU097",
          "KU098",
          "KU102",
          "KU103",
          "KU105",
          "KU106",
          "KU108",
          "KU109",
          "KU139",
          "KU140",
          "KU142",
          "KU143",
          "KU145",
          "KU146",
          "KU153",
          "KU148",
          "KU149",
          "KU151",
          "KU152",
          "KU165",
          "KU167",
          "KU169",
          "KU170",
          "KU171",
          "KU172",
          "KU176",
          "KU177",
          "KU178",
          "KU179",
          "KU181",
          "KU182",
          "KU186",
          "KU202",
          "KU204",
          "KU205",
          "KU208",
          "KU211",
          "KU213",
          "KU214",
          "KU216",
          "KU217",
          "KU218",
          "KU224",
          "KU226",
          "KU230",
          "KU231",
          "KU232",
          "KU233",
          "KU235",
          "KU236",
          "KU239",
          "KU240",
          "KU320",
          "KU241",
          "KU322",
          "KU244",
          "KU245",
          "KU249",
          "KU250",
          "KU256",
          "KU257",
          "KU260",
          "KU261",
          "KU263",
          "KU265",
          "KU271",
          "KU272",
          "KU273",
          "KU275",
          "KU276",
          "KU280",
          "KU284",
          "KU285",
          "KU286",
          "KU287",
          "KU288",
          "KU290",
          "KU291",
          "KU295",
          "KU297",
          "KU300",
          "KU301",
          "KU304",
          "KU305",
          "KU312",
          "KU316",
          "KU317",
          "KU318",
          "KU398",
          "KU399",
          "KU400",
          "KU407",
          "KU402",
          "KU403",
          "KU405",
          "KU408",
          "KU410",
          "KU416",
          "KU417",
          "KU418",
          "KU420",
          "KU421",
          "KU422",
          "KU423",
          "KU425",
          "KU426",
          "KU444",
          "KU430",
          "KU433",
          "KU434",
          "KU435",
          "KU436",
          "KU438",
          "KU440",
          "KU441",
          "KU475",
          "KU478",
          "KU480",
          "KU481",
          "KU483",
          "KU484",
          "KU489",
          "KU491",
          "KU494",
          "KU495",
          "KU498",
          "KU499",
          "KU500",
          "KU503",
          "KU504",
          "KU505",
          "KU508",
          "KU507",
          "KU529",
          "KU531",
          "KU535",
          "KU536",
          "KU538",
          "KU541",
          "KU543",
          "KU545",
          "KU560",
          "KU561",
          "KU562",
          "KU563",
          "KU564",
          "KU309",
          "KU576",
          "KU577",
          "KU578",
          "KU445",
          "KU580",
          "KU581",
          "KU599",
          "KU583",
          "KU854",
          "KU584",
          "KU588",
          "KU592",
          "KU593",
          "KU595",
          "KU598",
          "KU601",
          "KU604",
          "KU607",
          "KU608",
          "KU609",
          "KU611",
          "KU638",
          "KU614",
          "KU615",
          "KU616",
          "KU619",
          "KU620",
          "KU623",
          "KU624",
          "KU625",
          "KU626",
          "KU630",
          "KU631",
          "KU635",
          "KU636",
          "KU678",
          "KU710",
          "KU680",
          "KU681",
          "KU683",
          "KU684",
          "KU686",
          "KU687",
          "KU689",
          "KU691",
          "KU694",
          "KU697",
          "KU698",
          "KU700",
          "KU702",
          "KU704",
          "KU707",
          "KU729",
          "KU732",
          "KU734",
          "KU736",
          "KU790",
          "KU738",
          "KU739",
          "KU740",
          "KU742",
          "KU743",
          "KU746",
          "KU747",
          "KU748",
          "KU791",
          "KU749",
          "KU751",
          "KU753",
          "KU755",
          "KU758",
          "KU759",
          "KU761",
          "KU762",
          "KU765",
          "KU766",
          "KU768",
          "KU771",
          "KU777",
          "KU778",
          "KU781",
          "KU783",
          "KU831",
          "KU832",
          "KU833",
          "KU834",
          "KU837",
          "KU844",
          "KU845",
          "KU846",
          "KU848",
          "KU849",
          "KU850",
          "KU851",
          "KU853",
          "KU857",
          "KU858",
          "KU859",
          "KU886",
          "KU887",
          "KU889",
          "KU890",
          "KU892",
          "KU893",
          "KU895",
          "KU785",
          "KU905",
          "KU908",
          "KU092",
          "KU915",
          "KU918",
          "KU921",
          "KU922",
          "KU924",
          "KU925",
          "KU927",
          "KU931",
          "KU934",
          "KU935",
          "KU936",
          "KU941",
          "KU946",
          "KU976",
          "KU977",
          "KU980",
          "KU981",
          "KU989",
          "KU992"
        ]
      }
    },
    {
      "code": "Toimiala", // All Industries
      "selection": {
        "filter": "item",
        "values": [
          "SSS"
        ]
      }
    },
    {
      "code": "Sukupuoli", // Both female and men
      "selection": {
        "filter": "item",
        "values": [
          "SSS"
        ]
      }
    },
    {
      "code": "Vuosi",
      "selection": {
        "filter": "item",
        "values": [
           "2007", "2008", "2009", "2010", "2011",
           "2012", "2013", "2014", "2015", "2016", "2017",
           "2018", "2019", "2020", "2021", "2022", "2023"
          ]
      }
    },
  ],
  "response": {
    "format": "json-stat2"
  }
}


selectedData = {}
let statData = null;
let employmentData = null;
let map; // global so it can be updated in real time
let geoJson;
let lastYear = new Date().getFullYear() - 1;
let selectedYear = lastYear; // Default to 2024
let fertility = 0;
let yearInfo = null;
let mapLegend;
let isAverageMode = false;
let currentView = 'average';
const WORKING_AGE_RATIO = 0.60; // Doing this so data becomes more real.
let printPlugin;
let population2AverageValue = 0;
let population2TotalValue = 0;


const averageToggleBtn = document.getElementById('average-toggle');
const yearSlider = document.getElementById('year-slider');
const yearDisplay = document.getElementById('year-display');
const sliderContainer = document.querySelector('.slider-container');

averageToggleBtn.addEventListener('click', function() {
    isAverageMode = !isAverageMode;
    currentView = 'average';
    if (isAverageMode) {
        averageToggleBtn.textContent = "Show By Year";
        averageToggleBtn.classList.add('active');
        sliderContainer.classList.add('disabled');
        if(currentTab !== "employment") {
          yearDisplay.textContent = `1990-${lastYear}`;
        } else {
          yearDisplay.textContent = `2007-${lastYear-1}`;
        }
    } else {
        averageToggleBtn.textContent = "Show Averages";
        averageToggleBtn.classList.remove('active');
        sliderContainer.classList.remove('disabled');
        yearDisplay.textContent = selectedYear;
    }
    
    updateData();
});

yearSlider.addEventListener('input', function() {
    selectedYear = parseInt(yearSlider.value);
    yearDisplay.textContent = selectedYear;
    updateData();
});

let currentTab = localStorage.getItem('currentTab') || 'population' // This saves the current tab even after reload. Used for various things.
console.log(currentTab)

if (currentTab === 'employment') {
    currentTab = 'population';
    selectedYear = 2023;
    yearDisplay.textContent = selectedYear;
    localStorage.setItem('currentTab', currentTab);
}

const closeStatsBtn = document.getElementById('close-stats-btn'); // Close button for specific stats of Cities on the map. Useful for phone
closeStatsBtn.addEventListener('click', function() {
    document.getElementById('statistic-display-specific').style.display = 'none';
});

const getData = async() => {

      // Get a lot of useful Finnish Data (Population, vitals, migration, family.)
      const url1 = "https://statfin.stat.fi:443/PxWeb/api/v1/en/StatFin/ssaaty/statfin_ssaaty_pxt_121w.px"
    
      const res = await fetch(url1, {
          method: "POST",
          headers: {"content-type": "application/json"},
          body: JSON.stringify(jsonQuery)
      })
      
      if(!res.ok) {
          return;
      }
      statData = await res.json()
      // console.log(statData)

      // Get employment stats
      const url2 = "https://pxdata.stat.fi/PxWeb/api/v1/en/StatFin/tyokay/statfin_tyokay_pxt_115i.px"
      const res2 = await fetch(url2, {
              method: "POST",
              headers: {"content-type": "application/json"},
              body: JSON.stringify(jsonQuery2)
      })
      employmentData = await res2.json()
      // console.log(employmentData)

      // Get Finnish Municipalities Bounds
      const url3 = "https://geo.stat.fi/geoserver/wfs?service=WFS&version=2.0.0&request=GetFeature&typeName=tilastointialueet:kunta4500k&outputFormat=json&srsName=EPSG:4326"
      const res3 = await fetch(url3)
      const geoData = await res3.json()
      // console.log(geoData)

      // const allMunicipalities = [];
      // municipalityKeys.forEach(key => { // Get all municipalities
      //     allMunicipalities.push({
      //         code: key,
      //         name: municipalities[key]
      //     });
      // });

      // const allMunicipalitiesEmployment = [];
      // municipalityKeysEmployment.forEach(key => { // Get all municipalities for employment
      //     allMunicipalitiesEmployment.push({
      //         code: key,
      //         name: municipalities[key]
      //     });
      // });

      // I DID THIS TO SEE IF THEY'RE THE SAME. There's a mismatch. So I cannot loop at the same index. :(

      
      employmentValues = {}
      const municipalities2 = employmentData.dimension.Alue.category.label
      const municipalityKeys2 = Object.keys(municipalities2)
      const allValues2 = employmentData.value
      const municipalityCount = municipalityKeys2.length;
      const yearCount = 2024 - 2007 + 1;

      for (let i = 0; i < municipalityCount; i++) {
          const employmentCode = municipalityKeys2[i];
          employmentValues[employmentCode] = [];
          for (let y = 0; y < yearCount; y++) {
              const index = i * yearCount + y;
              employmentValues[employmentCode].push(allValues2[index]);
          }
      }

      console.log(employmentValues)

      const municipalities = statData.dimension.Alue.category.label
      const allValues = statData.value
      
      
      const metricsPerMunicipality = 8;
      const municipalityKeys = Object.keys(municipalities);


      for (let i = 0; i < municipalityKeys.length; i++) { // Save every municipality with their stats.
          let key = municipalityKeys[i];
          const baseIndex = i * metricsPerMunicipality;
          
          selectedData[key] = {
              name: municipalities[key],
              code: key,
              births: allValues[baseIndex],
              deaths: allValues[baseIndex + 1],
              immigration: allValues[baseIndex + 2],
              emigration: allValues[baseIndex + 3],
              migration: allValues[baseIndex + 4],
              marriages: allValues[baseIndex + 5],
              divorces: allValues[baseIndex + 6],
              population: allValues[baseIndex + 7],
              employment: employmentValues[key], // Only matched by the key (mun. code, not by iteration)
          }
          // console.log(key, key2)
      }

      console.log(selectedData)
      
      changeTab(); // Make sure correct tab shows.
      initMap(geoData) // Create map with the data.
      updateData();
}

const yearTab = document.querySelector('.stat-tab[data-view="year"]');
const averageTab = document.querySelector('.stat-tab[data-view="average"]');
if(!isAverageMode) { 
    currentView = 'year'; // By Year is the default view for the specific stats of a municipality.
}
yearTab.addEventListener('click', function() {
  yearTab.classList.add('active');
  averageTab.classList.remove('active')
  currentView = 'year';
  updateSelectedMunicipalityDisplay();
});

averageTab.addEventListener('click', function() {
  averageTab.classList.add('active');
  yearTab.classList.remove('active')
  currentView = 'average';
  updateSelectedMunicipalityDisplay();
});

function formatNumber(num) {
  if (num > 0) {
    return '+' + num; // Add + to positive numbers
  } else {
    return num;
  }
}

function updateSelectedMunicipalityDisplay() { // Show all details of the municipality in the container
  const information = document.getElementById('statistic-display-specific');
  
  if (currentView === 'year') {
    yearInfo.innerHTML = `<b>${selectedYear}</b>`;
  } else {
    if(currentTab !== "employment") {
      yearInfo.innerHTML = `<b>1990-${lastYear}</b>`;
    } else {
      yearInfo.innerHTML = `<b>2007-${lastYear-1}</b>`;
    }
  }

  if (information.style.display === 'block') {
      const municipalityName = document.querySelector('.stat-name-specific').textContent;

      let currentData = null;
      Object.values(selectedData).forEach(element => {
          if (element.name === municipalityName) {
              currentData = element;
          }
      });

      fertility = currentData.births - currentData.deaths
      
      if (currentData) {
          const descriptionElement = document.querySelector('.stat-description-specific');
          const averageStats = getAverageStats(municipalityName);

          if (currentTab === 'population' || currentTab === 'births' || currentTab === 'deaths'|| currentTab === 'vitals') { // When population/births/deaths/net vitals are selected

                if(currentView === 'year') {
                  const birthsPerCapita = ((currentData.births / currentData.population) * 1000).toFixed(1);
                  const deathsPerCapita = ((currentData.deaths / currentData.population) * 1000).toFixed(1);
                  const fertilityPerCapita = ((birthsPerCapita - deathsPerCapita ) / currentData.population * 1000).toFixed(2);

                  descriptionElement.innerHTML = 
                  `Population: <b>${currentData.population}</b><br>
                  Births: <b>${formatNumber(currentData.births)}</b> <small>(${birthsPerCapita} per 1,000 people)</small><br>
                  Deaths: <b>-${currentData.deaths}</b> <small>(${deathsPerCapita} per 1,000 people)</small><br>
                  Net Fertility: <b>${formatNumber(fertility)}</b> <small>(${fertilityPerCapita} per 1,000 people)</small>`;
                } else {
                  const growthPercentage = ((averageStats.totalGrowth / averageStats.initialPopulation) * 100).toFixed(2);
                  const avgBirthsPerCapita = ((averageStats.averageBirths / averageStats.averagePopulation) * 1000).toFixed(1);
                  const avgDeathsPerCapita = ((averageStats.averageDeaths / averageStats.averagePopulation) * 1000).toFixed(1);
                  descriptionElement.innerHTML = 
                  `<h4>Total stats:</h4>
                  Population growth: <b>${formatNumber(averageStats.totalGrowth)}</b> <small>(${growthPercentage}% change)</small><br>
                  Total Births: <b>${formatNumber(averageStats.totalBirths)}</b><br>
                  Total Deaths: <b>-${averageStats.totalDeaths}</b><br>
                  <br>
                  <h4>Average stats:</h4>
                  Average Population: <b>${averageStats.averagePopulation} people</b><br>
                  Births by year: <b>${formatNumber(averageStats.averageBirths)}</b> <small>(${avgBirthsPerCapita} per 1,000 people)</small><br>
                  Deaths by year: <b>-${averageStats.averageDeaths}</b> <small>(${avgDeathsPerCapita} per 1,000 people)</small><br>
                  Net Fertility: <b>${formatNumber(averageStats.averageFertility)}</b><br>`;
                }
        } else if (currentTab === 'immigration') { // When immigration is selected
                
                if(currentView === 'year') {
                  const immigrationPerCapita = ((currentData.immigration / currentData.population) * 1000).toFixed(1);

                  descriptionElement.innerHTML = 
                  `Population: <b>${currentData.population}</b><br>
                  Immigration: <b>${formatNumber(currentData.immigration)}</b> <small>(${immigrationPerCapita} per 1,000 people)</small><br>`;
                } else {
                  const avgImmigrationPerYear = Math.round(averageStats.totalImmigration / averageStats.totalYears);
                  const avgImmigrationPerCapita = ((avgImmigrationPerYear / averageStats.averagePopulation) * 1000).toFixed(1);
                  
                  descriptionElement.innerHTML = 
                  `<h4>Total stats:</h4>
                  Total Immigration: <b>${formatNumber(averageStats.totalImmigration)}</b><br>
                  <br>
                  <h4>Average stats:</h4>
                  Average Population: <b>${averageStats.averagePopulation} people</b><br>
                  Immigration by year: <b>${formatNumber(avgImmigrationPerYear)}</b> <small>(${avgImmigrationPerCapita} per 1,000 people)</small><br>`;
                }
        } else if (currentTab === 'emigration') { // When emigration is selected
                
                if(currentView === 'year') {
                  const emigrationPerCapita = ((currentData.emigration / currentData.population) * 1000).toFixed(1);
                  descriptionElement.innerHTML = 
                  `Population: <b>${currentData.population}</b><br>
                  Emigration: <b>${formatNumber(currentData.emigration)}</b> <small>(${emigrationPerCapita} per 1,000 people)</small><br>`;
                } else {
                  const avgEmigrationPerYear = Math.round(averageStats.totalEmigration / averageStats.totalYears);
                  const avgEmigrationPerCapita = ((avgEmigrationPerYear / averageStats.averagePopulation) * 1000).toFixed(1);
                  
                  descriptionElement.innerHTML = 
                  `<h4>Total stats:</h4>
                  Total Emigration: <b>${formatNumber(averageStats.totalEmigration)}</b><br>
                  <br>
                  <h4>Average stats:</h4>
                  Average Population: <b>${averageStats.averagePopulation} people</b><br>
                  Emigration by year: <b>${formatNumber(avgEmigrationPerYear)}</b> <small>(${avgEmigrationPerCapita} per 1,000 people)</small><br>`;
                }
        } else if (currentTab === 'migration') { // When Net Migration is selected
                const migrationPerCapita = ((currentData.migration / currentData.population) * 1000).toFixed(1);
                
                if(currentView === 'year') {
                  descriptionElement.innerHTML = 
                  `Total population: <b>${currentData.population}</b><br>
                  Immigration: <b>${formatNumber(currentData.immigration)}</b><br>
                  Emigration: <b>-${currentData.emigration}</b><br>
                  Net Migration: <b>${formatNumber(currentData.migration)}</b> <small>(${migrationPerCapita} per 1,000 people)</small>`;
                } else {
                  const netMigration = averageStats.totalImmigration - averageStats.totalEmigration;
                  const avgMigrationPerYear = Math.round(netMigration / averageStats.totalYears);
                  const avgMigrationPerCapita = ((avgMigrationPerYear / averageStats.averagePopulation) * 1000).toFixed(1);
                  
                  descriptionElement.innerHTML = 
                  `<h4>Total stats:</h4>
                  Total population: <b>${formatNumber(currentData.population)}</b><br>
                  Total Immigration: <b>${formatNumber(averageStats.totalImmigration)}</b><br>
                  Total Emigration: <b>-${averageStats.totalEmigration}</b><br>
                  Net Migration: <b>${formatNumber(netMigration)}</b><br>
                  <br>
                  <h4>Average stats:</h4>
                  Population growth: <b>${formatNumber(averageStats.totalGrowth)}</b> <small>(${growthPercentage}% change)</small><br>
                  Net Migration by year: <b>${formatNumber(avgMigrationPerYear)}</b> <small>(${avgMigrationPerCapita} per 1,000 people)</small><br>`;
                }
        } else if (currentTab === 'marriages') {
                  if(currentView === 'year') {
                      const marriagesPerCapita = ((currentData.marriages / currentData.population) * 1000).toFixed(1);
                      
                      descriptionElement.innerHTML = 
                      `Population: <b>${currentData.population}</b><br>
                      Marriages: <b>${formatNumber(currentData.marriages)}</b> <small>(${marriagesPerCapita} per 1,000 people)</small><br>`;
                  } else {
                      const avgMarriagesPerYear = Math.round(averageStats.totalMarriages / averageStats.totalYears);
                      const avgMarriagesPerCapita = ((avgMarriagesPerYear / averageStats.averagePopulation) * 1000).toFixed(1);
                      
                      descriptionElement.innerHTML = 
                      `<h4>Total stats:</h4>
                      Total population: <b>${currentData.population}</b><br>
                      Total Marriages: <b>${formatNumber(averageStats.totalMarriages)}</b><br>
                      <br>
                      <h4>Average stats:</h4>
                      Average Population: <b>${averageStats.averagePopulation} people</b><br>
                      Marriages by year: <b>${formatNumber(avgMarriagesPerYear)}</b> <small>(${avgMarriagesPerCapita} per 1,000 people)</small><br>`;
                  }
        } else if (currentTab === 'divorces') {
                if(currentView === 'year') {
                    const divorcesPerCapita = ((currentData.divorces / currentData.population) * 1000).toFixed(1);
                    
                    descriptionElement.innerHTML = 
                    `Population: <b>${currentData.population}</b><br>
                    Divorces: <b>${formatNumber(currentData.divorces)}</b> <small>(${divorcesPerCapita} per 1,000 people)</small><br>`;
                } else {
                    const avgDivorcesPerYear = Math.round(averageStats.totalDivorces / averageStats.totalYears);
                    const avgDivorcesPerCapita = ((avgDivorcesPerYear / averageStats.averagePopulation) * 1000).toFixed(1);
                    
                    descriptionElement.innerHTML = 
                    `<h4>Total stats:</h4>
                    Total population: <b>${currentData.population}</b><br>
                    Total Divorces: <b>${formatNumber(averageStats.totalDivorces)}</b><br>
                    <br>
                    <h4>Average stats:</h4>
                    Average Population: <b>${averageStats.averagePopulation} people</b><br>
                    Divorces by year: <b>${formatNumber(avgDivorcesPerYear)}</b> <small>(${avgDivorcesPerCapita} per 1,000 people)</small><br>`;
                }
        } else if (currentTab === 'family') {
                
                if(currentView === 'year') {
                  const marriagesPerCapita = ((currentData.marriages / currentData.population) * 1000).toFixed(1);
                  const divorcesPerCapita = ((currentData.divorces / currentData.population) * 1000).toFixed(1);
                  const netFamilyPerCapita = (marriagesPerCapita - divorcesPerCapita).toFixed(1);
                  const marriageDivorceRatio = currentData.divorces > 0 ? (currentData.marriages / currentData.divorces).toFixed(2) : "∞";
                  
                  descriptionElement.innerHTML = 
                  `Population: <b>${currentData.population}</b><br>
                  Marriages: <b>${formatNumber(currentData.marriages)}</b> <small>(${marriagesPerCapita} per 1,000 people)</small><br>
                  Divorces: <b>-${currentData.divorces}</b> <small>(${divorcesPerCapita} per 1,000 people)</small><br>
                  Net Family Balance: <b>${netFamilyPerCapita}</b> <small>(per 1,000 people)</small><br>
                  Marriage/Divorce ratio: <b>${marriageDivorceRatio}</b>`;
                } else {
                  const netFamily = averageStats.totalMarriages - averageStats.totalDivorces;
                  const avgFamilyPerYear = Math.round(netFamily / averageStats.totalYears);
                  const avgFamilyPerCapita = ((avgFamilyPerYear / averageStats.averagePopulation) * 1000).toFixed(1);
                  
                  descriptionElement.innerHTML = 
                  `<h4>Total stats:</h4>
                  Total population: <b>${currentData.population}</b><br>
                  Total Marriages: <b>${formatNumber(averageStats.totalMarriages)}</b><br>
                  Total Divorces: <b>-${averageStats.totalDivorces}</b><br>
                  Net Family: <b>${formatNumber(netFamily)}</b><br>
                  <br>
                  <h4>Average stats:</h4>
                  Average Population: <b>${averageStats.averagePopulation} people</b><br>
                  Net Family by year: <b>${formatNumber(avgFamilyPerYear)}</b> <small>(${avgFamilyPerCapita} per 1,000 people)</small><br>`;
                }
        } else if (currentTab === 'employment') {
                if(currentView === 'year') {
                    const employmentPercentage = ((currentData.employment / (currentData.population * WORKING_AGE_RATIO)) * 100).toFixed(1);
                    descriptionElement.innerHTML = 
                    `Population: <b>${currentData.population} people</b><br>
                    Total Employment: <b>${currentData.employment} people</b><br>
                    % of Employed: <b>${employmentPercentage}%</b>`;
                } else {
                    console.log("It does work it just doens't show.")
                    const avgEmploymentPerYear = Math.round(averageStats.totalEmployments / averageStats.countedYears2);
                    const avgPopulation = averageStats.averagePopulation2;
                    const avgEmploymentPercentage = ((avgEmploymentPerYear / (avgPopulation * WORKING_AGE_RATIO)) * 100).toFixed(1);
                    
                    descriptionElement.innerHTML = 
                    `<h4>Total stats:</h4>
                    Total population: <b>${currentData.population} people</b><br>
                    Total employed: <b>${averageStats.totalEmployments} people</b><br>
                    <h4>Average stats:</h4>
                    Average Population: <b>${avgPopulation} people</b><br>
                    Employments by year: <b>${avgEmploymentPerYear} people</b><br>
                    Population employed: <b>${avgEmploymentPercentage}%</b>`
                }
          }
        }
      }
    }

function changeTab() {  
    const populationTab = document.querySelector('.nav-link[data-stat="population"]');
    const birthTab = document.querySelector('.dropdown-item[data-stat="births"]');
    const deathTab = document.querySelector('.dropdown-item[data-stat="deaths"]');
    const vitalTab = document.querySelector('.dropdown-item[data-stat="vitals"]');
    const immigrationTab = document.querySelector('.dropdown-item[data-stat="immigration"]');
    const emigrationTab = document.querySelector('.dropdown-item[data-stat="emigration"]');
    const migrationTab = document.querySelector('.dropdown-item[data-stat="migration"]');
    const marriagesTab = document.querySelector('.dropdown-item[data-stat="marriages"]');
    const divorcesTab = document.querySelector('.dropdown-item[data-stat="divorces"]');
    const familyTab = document.querySelector('.dropdown-item[data-stat="family"]');

    const employmentTab = document.querySelector('.nav-link[data-stat="employment"]');

    const statName = document.querySelector('.stat-name');
    const statDescription = document.querySelector('.stat-description')

    if (populationTab) {
        populationTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;

            currentTab = 'population';
            localStorage.setItem('currentTab', currentTab);
            console.log('Population tab clicked:', populationTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }

    if (birthTab) {
        birthTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;

            currentTab = 'births';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }

    if (deathTab) {
        deathTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'deaths';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }

    if (vitalTab) {
        vitalTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'vitals';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }
    
    if (immigrationTab) {
        immigrationTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'immigration';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }
    
    if (emigrationTab) {
        emigrationTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'emigration';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }
    
    if (migrationTab) {
        migrationTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'migration';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }
    
    if (marriagesTab) {
        marriagesTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'marriages';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }
    
    if (divorcesTab) {
        divorcesTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'divorces';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }
    
    if (familyTab) {
        familyTab.addEventListener('click', function(e) {
            yearSlider.min = 1990;
            yearSlider.max = 2024;
            
            currentTab = 'family';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
            updateData();
            updateLegend();
        });
    }

    if (employmentTab) {
        employmentTab.addEventListener('click', function(e) {
            currentTab = 'employment';
            localStorage.setItem('currentTab', currentTab);
            statName.textContent = currentTab;
            statDescription.textContent = `Employment rates across Finnish municipalities (2007-2023)`;
            if (selectedYear < 2007 || selectedYear > lastYear) {
                selectedYear = lastYear - 1;
                yearDisplay.textContent = selectedYear;
                yearSlider.value = selectedYear;
            }

            yearSlider.min = 2007;
            yearSlider.max = 2023;

            updateData();
            updateLegend();
        });
    }

}

const initMap = (data) => {
  if (!map) {
      map = L.map('map', {
          minZoom: 5,
          zoomControl: false
      })

      L.control.zoom({
          position: 'topright'
      }).addTo(map)
    

      geoJson = L.geoJson(data, {
            onEachFeature: getFeature,
            style: getStyle,
            weight: 2
      }).addTo(map)

      let osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap"
      }).addTo(map)

      mapLegend = L.control({ position: 'bottomright' }); // Add map legend as default
      mapLegend.onAdd = function(map) {
          var div = L.DomUtil.create('div', 'legend');
          updateLegendContent(div);
          return div;
      };
        mapLegend.addTo(map);
      };

      mapLegend.addTo(map);

      map.fitBounds(geoJson.getBounds())

      map.setView([65.5, 26.0], 5); // Middle of Finland

      // console.log("Map was added.")

      printPlugin = L.easyPrint({
          title: 'Download map',
          sizeModes: ['A4Landscape'],
          exportOnly: true,
          hideControlContainer: true
      }).addTo(map);


      setTimeout(() => {
          document.querySelector('.loading-overlay').classList.add('fade-out'); // Show loading overlay when the page is loaded.
          document.body.classList.add('loaded');
          
          setTimeout(() => {
              const overlay = document.querySelector('.loading-overlay');
              if (overlay && overlay.parentNode) {
                  overlay.parentNode.removeChild(overlay);
              }
          }, 1000);
      }, 500);

      changeTab();
  }


const downloadMapBtn = document.getElementById('download-map-btn');
downloadMapBtn.addEventListener('click', function() {
    map.setView([65.5, 26.0], 5); // This makes sure that the map is centered before saving the map
    setTimeout(() => {
      if(currentView !== "average") {
        printPlugin.printMap('CurrentSize', `Finland_${currentTab}_${selectedYear}`);
      } else {
        printPlugin.printMap('CurrentSize', `Finland_${currentTab}_2007_${lastYear}_average`);
      }
    }, 1000);
});


function updateLegendContent(div) { // Update Legend content based on the tab selected
    div.innerHTML = '';

    if (isAverageMode && currentTab === 'population') {
        div.innerHTML = `<h4>Population Growth (1990-${lastYear})</h4>`;
        div.innerHTML += '<i style="background: #006837"></i> > 50%<br>';
        div.innerHTML += '<i style="background: #1a9850"></i> 30% - 50%<br>';
        div.innerHTML += '<i style="background: #66bd63"></i> 20% - 30%<br>';
        div.innerHTML += '<i style="background: #a6d96a"></i> 10% - 20%<br>';
        div.innerHTML += '<i style="background: #d9ef8b"></i> 5% - 10%<br>';
        div.innerHTML += '<i style="background: #ffffbf"></i> 0% - 5%<br>';
        div.innerHTML += '<i style="background: #fee08b"></i> -5% - 0%<br>';
        div.innerHTML += '<i style="background: #fdae61"></i> -10% - -5%<br>';
        div.innerHTML += '<i style="background: #f46d43"></i> -20% - -10%<br>';
        div.innerHTML += '<i style="background: #d73027"></i> < -20%<br>';
    } else {
      if(currentTab === 'population') {
          div.innerHTML = '<h4>Population</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 500,000<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 200,000 - 500,000<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 100,000 - 200,000<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 50,000 - 100,000<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 20,000 - 50,000<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 10,000 - 20,000<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 5,000 - 10,000<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 2,000 - 5,000<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 1,000 - 2,000<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < 1,000<br>';
      } else if(currentTab === 'births') {
          div.innerHTML = '<h4>Births</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 5,000<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 1,000 - 5,000<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 10 - 20<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 5 - 10<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < 5<br>';
      } else if(currentTab === 'deaths') {
          div.innerHTML = '<h4>Deaths</h4>';
          div.innerHTML += '<i style="background: #d73027"></i> > 5,000<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 1,000 - 5,000<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 10 - 20<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 5 - 10<br>';
          div.innerHTML += '<i style="background: #006837"></i> < 5<br>';
      } else if(currentTab === 'vitals') {
          div.innerHTML = '<h4>Net Vitals (Births - Deaths)</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 1,000<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 0 - 50<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> -50 - 0<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> -100 - -50<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> -200 - -100<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < -200<br>';
        } else if(currentTab === 'immigration') {
          div.innerHTML = '<h4>Immigration</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 5,000<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 1,000 - 5,000<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 10 - 20<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 5 - 10<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < 5<br>';
      } else if(currentTab === 'emigration') {
          div.innerHTML = '<h4>Emigration</h4>';
          div.innerHTML += '<i style="background: #d73027"></i> > 5,000<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 1,000 - 5,000<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 10 - 20<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 5 - 10<br>';
          div.innerHTML += '<i style="background: #006837"></i> < 5<br>';
      } else if(currentTab === 'migration') {
          div.innerHTML = '<h4>Net Migration</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 1,000<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 0 - 50<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> -50 - 0<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> -100 - -50<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> -200 - -100<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < -200<br>';
      } else if(currentTab === 'marriages') {
          div.innerHTML = '<h4>Marriages</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 1,000<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 500 - 1,000<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 10 - 20<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 5 - 10<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 1 - 5<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < 1<br>';
      } else if(currentTab === 'divorces') {
          div.innerHTML = '<h4>Divorces</h4>';
          div.innerHTML += '<i style="background: #d73027"></i> > 500<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 10 - 20<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 5 - 10<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 2 - 5<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 1 - 2<br>';
          div.innerHTML += '<i style="background: #006837"></i> < 1<br>';
      } else if(currentTab === 'family') {
          div.innerHTML = '<h4>Marriage-Divorce Balance</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 500<br>';
          div.innerHTML += '<i style="background: #1a9850"></i> 200 - 500<br>';
          div.innerHTML += '<i style="background: #66bd63"></i> 100 - 200<br>';
          div.innerHTML += '<i style="background: #a6d96a"></i> 50 - 100<br>';
          div.innerHTML += '<i style="background: #d9ef8b"></i> 20 - 50<br>';
          div.innerHTML += '<i style="background: #ffffbf"></i> 0 - 20<br>';
          div.innerHTML += '<i style="background: #fee08b"></i> -20 - 0<br>';
          div.innerHTML += '<i style="background: #fdae61"></i> -50 - -20<br>';
          div.innerHTML += '<i style="background: #f46d43"></i> -100 - -50<br>';
          div.innerHTML += '<i style="background: #d73027"></i> < -100<br>';
      } else if (currentTab === 'employment') {
          div.innerHTML = '<h4>Employment Rate (%)</h4>';
          div.innerHTML += '<i style="background: #006837"></i> > 75% (Excellent)<br>';
          div.innerHTML += '<i style="background: #31a354"></i> 70% - 75% (Very Good)<br>';
          div.innerHTML += '<i style="background: #74c476"></i> 65% - 70% (Good)<br>';
          div.innerHTML += '<i style="background: #bae4b3"></i> 60% - 65% (Fair)<br>';
          div.innerHTML += '<i style="background: #ffffcc"></i> 55% - 60% (Neutral)<br>';
          div.innerHTML += '<i style="background: #fd8d3c"></i> 50% - 55% (Poor)<br>';
          div.innerHTML += '<i style="background: #f03b20"></i> 45% - 50% (Very Poor)<br>';
          div.innerHTML += '<i style="background: #bd0026"></i> < 45% (Critical)<br>';
      }
  }
}

function updateLegend() {
    if (map && mapLegend) {
        map.removeControl(mapLegend);
        mapLegend = L.control({ position: 'bottomright' });
        mapLegend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            updateLegendContent(div);
            return div;
        };
        mapLegend.addTo(map);
    }
}

function getAverageStats(municipalityName) { // Get average stats on every stat
    let years1 = Object.keys(statData.dimension.Vuosi.category.label);
    let totalYears = years1.length;

    let years2 = Object.keys(employmentData.dimension.Vuosi.category.label);
    let totalYears2 = years2.length;

    let totalEmployments = 0;

    let totalBirths = 0;
    let totalDeaths = 0;
    let totalPopulation = 0;
    let totalPopulation2 = 0;
    let countedYears2 = 0;
    let totalImmigration = 0;
    let totalEmigration = 0;
    let totalMarriages = 0;
    let totalDivorces = 0;
    let initialPopulation = 0;
    let finalPopulation = 0;

    for (let i = 0; i < totalYears; i++) {
      const year = years1[i];
      const yearIndex = statData.dimension.Vuosi.category.index[year];


      
      const municipalities = statData.dimension.Alue.category.label;
      const allValues = statData.value;
      const municipalityKeys = Object.keys(municipalities);
      const metricsPerMunicipality = 8;
      const municipalityCount = Object.keys(municipalities).length;
      const yearOffset = yearIndex * municipalityCount * metricsPerMunicipality; // This makes sure we access the right year.

      for (let j = 0; j < municipalityKeys.length; j++) { // for vital, family, migration.
            let key = municipalityKeys[j];
            if (municipalities[key] === municipalityName) {
                const baseIndex = yearOffset + (j * metricsPerMunicipality);
                
                totalBirths += allValues[baseIndex];
                totalDeaths += allValues[baseIndex + 1];
                totalImmigration += allValues[baseIndex + 2];
                totalEmigration += allValues[baseIndex + 3];
                totalMarriages += allValues[baseIndex + 5];
                totalDivorces += allValues[baseIndex + 6];
                totalPopulation += allValues[baseIndex + 7];

                if(parseInt(year) >= 2007) {
                  totalPopulation2 += allValues[baseIndex + 7];
                  countedYears2++;
                }
                
                if (i === 0) {
                    initialPopulation = allValues[baseIndex + 7];
                }
                

                if (i === years1.length - 1) {
                    finalPopulation = allValues[baseIndex + 7];
                }
                
                break;
            }
        }
    }

    for (let i = 0; i < totalYears2; i++) { // for employments
        const year = years2[i];
        const yearIndex = employmentData.dimension.Vuosi.category.index[year];

        const municipalities2 = employmentData.dimension.Alue.category.label;
        const allValues2 = employmentData.value;
        const municipalityKeys2 = Object.keys(municipalities2);

        for (let j = 0; j < municipalityKeys2.length; j++) {
            let key = municipalityKeys2[j];
            if (municipalities2[key] === municipalityName) {
                const index = j * totalYears2 + i;
                totalEmployments += allValues2[index];
                break;
            }
        }
    }

    const averageBirths = Math.round(totalBirths / totalYears);
    const averageDeaths = Math.round(totalDeaths / totalYears);
    const averagePopulation = Math.round(totalPopulation / totalYears);
    const averagePopulation2 = Math.round(totalPopulation2 / countedYears2);
    population2AverageValue = averagePopulation2;
    const totalGrowth = finalPopulation - initialPopulation;
    const averageFertility = Math.round((totalBirths - totalDeaths) / totalYears);
    
    return {
        totalYears,
        totalYears2,
        totalBirths,
        totalDeaths,
        totalGrowth,
        totalImmigration,
        totalEmigration,
        totalMarriages,
        totalDivorces,
        totalPopulation,
        totalPopulation2,
        totalEmployments,
        countedYears2,
        initialPopulation,
        finalPopulation,
        averageBirths,
        averageDeaths,
        averagePopulation,
        averagePopulation2,
        averageFertility
    };
}


const updateData = async() => {

    // Set specific year. Before I was creating another API request. I quickly realized that was a bad idea ;)
    const yearIndex = statData.dimension.Vuosi.category.index[selectedYear];
    const yearIndex2 = employmentData.dimension.Vuosi.category.index[selectedYear];

    const statName = document.querySelector('.stat-name');
    const statDescription = document.querySelector('.stat-description')

    if (isAverageMode) {
        if (currentTab === 'population') {
            statName.textContent = 'Population Growth';
            statDescription.textContent = `Population growth across Finnish municipalities (1990-${lastYear})`;
        } else {
            statName.textContent = `Average ${currentTab}`;
            if (currentTab !== "employment") {
              statDescription.textContent = `Average annual ${currentTab} across Finnish municipalities (1990-${lastYear})`;
            } else {
              statDescription.textContent = `Average annual ${currentTab} across Finnish municipalities (2007-${lastYear-1})`;
            }
        }
      } else {
        statName.textContent = currentTab;
        statDescription.textContent = `Total ${currentTab} across Finnish municipalities`;
      }

    yearInfo = document.querySelector('.stat-year-specific');
    if (currentView === 'year') {
      yearInfo.innerHTML = `<b>${selectedYear}</b>`;
    } else {
      if(currentTab !== "employment") {
        yearInfo.innerHTML = `<b>1990-${lastYear}</b>`;
      } else {
        yearInfo.innerHTML = `<b>2007-${lastYear-1}</b>`;
      }
    }

    if (yearIndex === undefined) {
        console.error(`Year ${selectedYear} not found in data`);
        return;
    }
      
    // Clear previous data
    selectedData = {};

    const municipalities = statData.dimension.Alue.category.label;
    const allValues = statData.value;
    const municipalityKeys = Object.keys(municipalities);
    const municipalityCount = Object.keys(municipalities).length;
    const metricsPerMunicipality = 8;
    const yearOffset = yearIndex * municipalityCount * metricsPerMunicipality; // This makes sure we access the right year.



    const municipalities2 = employmentData.dimension.Alue.category.label
    const municipalityKeys2 = Object.keys(municipalities2)
    const allValues2 = employmentData.value
    const municipalityCount2 = municipalityKeys2.length;
    const yearCount = 2024 - 2007;

    for (let i = 0; i < municipalityCount2; i++) {
        const employmentCode = municipalityKeys2[i];
        const index = i * yearCount + yearIndex2;
        employmentValues[employmentCode] = allValues2[index];
    }

    for (let i = 0; i < municipalityKeys.length; i++) {
        let key = municipalityKeys[i];

        const baseIndex = yearOffset + (i * metricsPerMunicipality); // For name-population
        
        selectedData[key] = {
            name: municipalities[key],
            code: key,
            births: allValues[baseIndex],
            deaths: allValues[baseIndex + 1],
            immigration: allValues[baseIndex + 2],
            emigration: allValues[baseIndex + 3],
            migration: allValues[baseIndex + 4],
            marriages: allValues[baseIndex + 5],
            divorces: allValues[baseIndex + 6],
            population: allValues[baseIndex + 7],
            employment: employmentValues[key]
        }
    }


    

    if (geoJson) {
        geoJson.setStyle(getStyle);
        const specificDisplay = document.getElementById('statistic-display-specific');
        if (specificDisplay.style.display === 'block') {
            const municipalityName = document.querySelector('.stat-name-specific').textContent;
            
            let updatedData = null;
            Object.values(selectedData).forEach(element => {
                if (element.name === municipalityName) {
                    updatedData = element;
                }
            });

            // fertility = updatedData.births - updatedData.deaths
            
            if (updatedData) {
              updateSelectedMunicipalityDisplay()
            }
        }
    }
    // console.log(`Data updated for year ${selectedYear}`);


}

const getFeature = (feature, layer) => {
    if(!feature.properties.id) return;

    let name = feature.properties.name;

    layer.bindTooltip(name);
    layer.on('click', function() {
        let currentData = null;
        Object.values(selectedData).forEach(element => {
            if(element.name === name) {
                currentData = element;
            }
        });
    if (currentData) {
          document.querySelector('.stat-name-specific').textContent = name;
          yearInfo = document.querySelector('.stat-year-specific');
          if (currentView === 'year') {
            yearInfo.innerHTML = `<b>${selectedYear}</b>`;
          } else {
            if(currentTab !== "employment") {
              yearInfo.innerHTML = `<b>1990-${lastYear}</b>`;
            } else {
              yearInfo.innerHTML = `<b>2007-${lastYear-1}</b>`;
            }
          }
          document.getElementById('statistic-display-specific').style.display = 'block';
          updateSelectedMunicipalityDisplay();
    }
  });
}

// here is where data is actually processed and as a result shows different colors based on the stat.
const getStyle = (feature) => {

   if(!feature.properties.id) return {fillColor: '#cccccc', weight: 1, color: '#333', fillOpacity: 0.7};

    let name = feature.properties.name;
    let data = null;

    Object.values(selectedData).forEach(element => {
      if(element.name === name) {
        data = element;
      }
    });

    if (!data) {
        console.log(`No data found for: ${name}`);
        return {fillColor: '#cccccc', weight: 1, color: '#333', fillOpacity: 0.7};
    }

    let fillColor = '';
   if (isAverageMode) {
        // Get average stats for this municipality
        const avgStats = getAverageStats(name);
        
        if(currentTab === 'population') {
            // For population, show growth instead of average
            const growthPercent = avgStats.totalGrowth / avgStats.initialPopulation * 100;
            
            if (growthPercent > 50) fillColor = '#006837';
            else if (growthPercent > 30) fillColor = '#1a9850';
            else if (growthPercent > 20) fillColor = '#66bd63';
            else if (growthPercent > 10) fillColor = '#a6d96a';
            else if (growthPercent > 5) fillColor = '#d9ef8b';
            else if (growthPercent > 0) fillColor = '#ffffbf';
            else if (growthPercent > -5) fillColor = '#fee08b';
            else if (growthPercent > -10) fillColor = '#fdae61';
            else if (growthPercent > -20) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if(currentTab === 'births') {
            const avgBirths = avgStats.averageBirths;
            
            if (avgBirths > 5000) fillColor = '#006837';    
            else if (avgBirths > 1000) fillColor = '#1a9850';
            else if (avgBirths > 500) fillColor = '#66bd63';
            else if (avgBirths > 200) fillColor = '#a6d96a';
            else if (avgBirths > 100) fillColor = '#d9ef8b';
            else if (avgBirths > 50) fillColor = '#ffffbf';
            else if (avgBirths > 20) fillColor = '#fee08b';
            else if (avgBirths > 10) fillColor = '#fdae61';
            else if (avgBirths > 5) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if(currentTab === 'deaths') {
            const avgDeaths = avgStats.averageDeaths;
            
            if (avgDeaths > 5000) fillColor = '#d73027';       
            else if (avgDeaths > 1000) fillColor = '#f46d43';
            else if (avgDeaths > 500) fillColor = '#fdae61';
            else if (avgDeaths > 200) fillColor = '#fee08b';
            else if (avgDeaths > 100) fillColor = '#ffffbf';
            else if (avgDeaths > 50) fillColor = '#d9ef8b';
            else if (avgDeaths > 20) fillColor = '#a6d96a';
            else if (avgDeaths > 10) fillColor = '#66bd63';
            else if (avgDeaths > 5) fillColor = '#1a9850';
            else fillColor = '#006837';
        } else if(currentTab === 'vitals') {
            const avgFertility = avgStats.averageFertility;
            
            if (avgFertility > 1000) fillColor = '#006837';
            else if (avgFertility > 500) fillColor = '#1a9850';
            else if (avgFertility > 200) fillColor = '#66bd63';
            else if (avgFertility > 100) fillColor = '#a6d96a';
            else if (avgFertility > 50) fillColor = '#d9ef8b';
            else if (avgFertility > 0) fillColor = '#ffffbf';
            else if (avgFertility > -50) fillColor = '#fee08b';
            else if (avgFertility > -100) fillColor = '#fdae61';
            else if (avgFertility > -200) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if (currentTab === 'immigration') {
            const avgImmigration = Math.round(avgStats.totalImmigration / avgStats.totalYears);
            
            if (avgImmigration > 5000) fillColor = '#006837';    
            else if (avgImmigration > 1000) fillColor = '#1a9850';
            else if (avgImmigration > 500) fillColor = '#66bd63';
            else if (avgImmigration > 200) fillColor = '#a6d96a';
            else if (avgImmigration > 100) fillColor = '#d9ef8b';
            else if (avgImmigration > 50) fillColor = '#ffffbf';
            else if (avgImmigration > 20) fillColor = '#fee08b';
            else if (avgImmigration > 10) fillColor = '#fdae61';
            else if (avgImmigration > 5) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if (currentTab === 'emigration') {
            const avgEmigration = Math.round(avgStats.totalEmigration / avgStats.totalYears);
            
            if (avgEmigration > 5000) fillColor = '#d73027';       
            else if (avgEmigration > 1000) fillColor = '#f46d43';
            else if (avgEmigration > 500) fillColor = '#fdae61';
            else if (avgEmigration > 200) fillColor = '#fee08b';
            else if (avgEmigration > 100) fillColor = '#ffffbf';
            else if (avgEmigration > 50) fillColor = '#d9ef8b';
            else if (avgEmigration > 20) fillColor = '#a6d96a';
            else if (avgEmigration > 10) fillColor = '#66bd63';
            else if (avgEmigration > 5) fillColor = '#1a9850';
            else fillColor = '#006837';
        } else if (currentTab === 'migration') {
            const netMigration = avgStats.totalImmigration - avgStats.totalEmigration;
            const avgMigration = Math.round(netMigration / avgStats.totalYears);
            
            if (avgMigration > 1000) fillColor = '#006837';
            else if (avgMigration > 500) fillColor = '#1a9850';
            else if (avgMigration > 200) fillColor = '#66bd63';
            else if (avgMigration > 100) fillColor = '#a6d96a';
            else if (avgMigration > 50) fillColor = '#d9ef8b';
            else if (avgMigration > 0) fillColor = '#ffffbf';
            else if (avgMigration > -50) fillColor = '#fee08b';
            else if (avgMigration > -100) fillColor = '#fdae61';
            else if (avgMigration > -200) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if (currentTab === 'marriages') {
            const avgMarriages = Math.round(avgStats.totalMarriages / avgStats.totalYears);
            
            if (avgMarriages > 1000) fillColor = '#006837';        
            else if (avgMarriages > 500) fillColor = '#1a9850';
            else if (avgMarriages > 200) fillColor = '#66bd63';
            else if (avgMarriages > 100) fillColor = '#a6d96a';
            else if (avgMarriages > 50) fillColor = '#d9ef8b';
            else if (avgMarriages > 20) fillColor = '#ffffbf';
            else if (avgMarriages > 10) fillColor = '#fee08b';
            else if (avgMarriages > 5) fillColor = '#fdae61';
            else if (avgMarriages > 1) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if (currentTab === 'divorces') {
            const avgDivorces = Math.round(avgStats.totalDivorces / avgStats.totalYears);
            
            if (avgDivorces > 500) fillColor = '#d73027';            
            else if (avgDivorces > 200) fillColor = '#f46d43';
            else if (avgDivorces > 100) fillColor = '#fdae61';
            else if (avgDivorces > 50) fillColor = '#fee08b';
            else if (avgDivorces > 20) fillColor = '#ffffbf';
            else if (avgDivorces > 10) fillColor = '#d9ef8b';
            else if (avgDivorces > 5) fillColor = '#a6d96a';
            else if (avgDivorces > 2) fillColor = '#66bd63';
            else if (avgDivorces > 1) fillColor = '#1a9850';
            else fillColor = '#006837';
        } else if (currentTab === 'family') {
            const netFamily = avgStats.totalMarriages - avgStats.totalDivorces;
            const avgFamily = Math.round(netFamily / avgStats.totalYears);
            
            if (avgFamily > 500) fillColor = '#006837';
            else if (avgFamily > 200) fillColor = '#1a9850';
            else if (avgFamily > 100) fillColor = '#66bd63';
            else if (avgFamily > 50) fillColor = '#a6d96a';
            else if (avgFamily > 20) fillColor = '#d9ef8b';
            else if (avgFamily > 0) fillColor = '#ffffbf';
            else if (avgFamily > -20) fillColor = '#fee08b';
            else if (avgFamily > -50) fillColor = '#fdae61';
            else if (avgFamily > -100) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if (currentTab === 'employment') {
            const avgEmploymentPerYear = Math.round(avgStats.totalEmployments / avgStats.countedYears2);
            const avgPopulation = population2AverageValue;
            const avgEmploymentRate = (avgEmploymentPerYear / (avgPopulation * WORKING_AGE_RATIO)) * 100;

            if (avgEmploymentRate > 75) fillColor = '#006837';
            else if (avgEmploymentRate > 70) fillColor = '#31a354';
            else if (avgEmploymentRate > 65) fillColor = '#74c476';
            else if (avgEmploymentRate > 60) fillColor = '#bae4b3';
            else if (avgEmploymentRate > 55) fillColor = '#ffffcc';
            else if (avgEmploymentRate > 50) fillColor = '#fd8d3c';
            else if (avgEmploymentRate > 45) fillColor = '#f03b20';
            else fillColor = '#bd0026';
        }
      } else {
        if(currentTab === 'population') {
            if (data.population > 500000) fillColor = '#006837';
            else if (data.population > 200000) fillColor = '#1a9850';
            else if (data.population > 100000) fillColor = '#66bd63';
            else if (data.population > 50000) fillColor = '#a6d96a';
            else if (data.population > 20000) fillColor = '#d9ef8b';
            else if (data.population > 10000) fillColor = '#ffffbf';
            else if (data.population > 5000) fillColor = '#fee08b';
            else if (data.population > 2000) fillColor = '#fdae61';
            else if (data.population > 1000) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if(currentTab === 'births') {
            if (data.births > 5000) fillColor = '#006837';    
            else if (data.births > 1000) fillColor = '#1a9850';
            else if (data.births > 500) fillColor = '#66bd63';
            else if (data.births > 200) fillColor = '#a6d96a';
            else if (data.births > 100) fillColor = '#d9ef8b';
            else if (data.births > 50) fillColor = '#ffffbf';
            else if (data.births > 20) fillColor = '#fee08b';
            else if (data.births > 10) fillColor = '#fdae61';
            else if (data.births > 5) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if(currentTab === 'deaths') {
            if (data.deaths > 5000) fillColor = '#d73027';       
            else if (data.deaths > 1000) fillColor = '#f46d43';
            else if (data.deaths > 500) fillColor = '#fdae61';
            else if (data.deaths > 200) fillColor = '#fee08b';
            else if (data.deaths > 100) fillColor = '#ffffbf';
            else if (data.deaths > 50) fillColor = '#d9ef8b';
            else if (data.deaths > 20) fillColor = '#a6d96a';
            else if (data.deaths > 10) fillColor = '#66bd63';
            else if (data.deaths > 5) fillColor = '#1a9850';
            else fillColor = '#006837';
        } else if(currentTab === 'vitals') {
            const netVitals = data.births - data.deaths;
            if (netVitals > 1000) fillColor = '#006837';
            else if (netVitals > 500) fillColor = '#1a9850';
            else if (netVitals > 200) fillColor = '#66bd63';
            else if (netVitals > 100) fillColor = '#a6d96a';
            else if (netVitals > 50) fillColor = '#d9ef8b';
            else if (netVitals > 0) fillColor = '#ffffbf';
            else if (netVitals > -50) fillColor = '#fee08b';
            else if (netVitals > -100) fillColor = '#fdae61';
            else if (netVitals > -200) fillColor = '#f46d43';
            else fillColor = '#d73027';
        } else if (currentTab === 'immigration') {
              if (data.immigration > 5000) fillColor = '#006837';    
              else if (data.immigration > 1000) fillColor = '#1a9850';
              else if (data.immigration > 500) fillColor = '#66bd63';
              else if (data.immigration > 200) fillColor = '#a6d96a';
              else if (data.immigration > 100) fillColor = '#d9ef8b';
              else if (data.immigration > 50) fillColor = '#ffffbf';
              else if (data.immigration > 20) fillColor = '#fee08b';
              else if (data.immigration > 10) fillColor = '#fdae61';
              else if (data.immigration > 5) fillColor = '#f46d43';
              else fillColor = '#d73027';         
          } else if (currentTab === 'emigration') {
              if (data.emigration > 5000) fillColor = '#d73027';       
              else if (data.emigration > 1000) fillColor = '#f46d43';
              else if (data.emigration > 500) fillColor = '#fdae61';
              else if (data.emigration > 200) fillColor = '#fee08b';
              else if (data.emigration > 100) fillColor = '#ffffbf';
              else if (data.emigration > 50) fillColor = '#d9ef8b';
              else if (data.emigration > 20) fillColor = '#a6d96a';
              else if (data.emigration > 10) fillColor = '#66bd63';
              else if (data.emigration > 5) fillColor = '#1a9850';
              else fillColor = '#006837';                               
          }  else if (currentTab === 'migration') {
              const netMigration = data.immigration - data.emigration;
              if (netMigration > 1000) fillColor = '#006837';
              else if (netMigration > 500) fillColor = '#1a9850';
              else if (netMigration > 200) fillColor = '#66bd63';
              else if (netMigration > 100) fillColor = '#a6d96a';
              else if (netMigration > 50) fillColor = '#d9ef8b';
              else if (netMigration > 0) fillColor = '#ffffbf';
              else if (netMigration > -50) fillColor = '#fee08b';
              else if (netMigration > -100) fillColor = '#fdae61';
              else if (netMigration > -200) fillColor = '#f46d43';
              else fillColor = '#d73027';
        } else if (currentTab === 'marriages') {
              if (data.marriages > 1000) fillColor = '#006837';        
              else if (data.marriages > 500) fillColor = '#1a9850';
              else if (data.marriages > 200) fillColor = '#66bd63';
              else if (data.marriages > 100) fillColor = '#a6d96a';
              else if (data.marriages > 50) fillColor = '#d9ef8b';
              else if (data.marriages > 20) fillColor = '#ffffbf';
              else if (data.marriages > 10) fillColor = '#fee08b';
              else if (data.marriages > 5) fillColor = '#fdae61';
              else if (data.marriages > 1) fillColor = '#f46d43';
              else fillColor = '#d73027';
        } else if (currentTab === 'divorces') {
              if (data.divorces > 500) fillColor = '#d73027';            
              else if (data.divorces > 200) fillColor = '#f46d43';
              else if (data.divorces > 100) fillColor = '#fdae61';
              else if (data.divorces > 50) fillColor = '#fee08b';
              else if (data.divorces > 20) fillColor = '#ffffbf';
              else if (data.divorces > 10) fillColor = '#d9ef8b';
              else if (data.divorces > 5) fillColor = '#a6d96a';
              else if (data.divorces > 2) fillColor = '#66bd63';
              else if (data.divorces > 1) fillColor = '#1a9850';
              else fillColor = '#006837'; 
        } else if (currentTab === 'family') {
              const netFamily = data.marriages - data.divorces;
              
              if (netFamily > 500) fillColor = '#006837';
              else if (netFamily > 200) fillColor = '#1a9850';
              else if (netFamily > 100) fillColor = '#66bd63';
              else if (netFamily > 50) fillColor = '#a6d96a';
              else if (netFamily > 20) fillColor = '#d9ef8b';
              else if (netFamily > 0) fillColor = '#ffffbf';
              else if (netFamily > -20) fillColor = '#fee08b';
              else if (netFamily > -50) fillColor = '#fdae61';
              else if (netFamily > -100) fillColor = '#f46d43';
              else fillColor = '#d73027';
        } else if (currentTab === 'employment') {
            const employmentRate = ((data.employment / (data.population * WORKING_AGE_RATIO)) * 100).toFixed(2);

            if (employmentRate > 75) fillColor = '#006837';
            else if (employmentRate > 70) fillColor = '#31a354';
            else if (employmentRate > 65) fillColor = '#74c476';
            else if (employmentRate > 60) fillColor = '#bae4b3';
            else if (employmentRate > 55) fillColor = '#ffffcc';
            else if (employmentRate > 50) fillColor = '#fd8d3c';
            else if (employmentRate > 45) fillColor = '#f03b20';
            else fillColor = '#bd0026';
        }
      }
    return {
        fillColor: fillColor,
        weight: 1,
        color: '#333',
        fillOpacity: 0.7
    };
}

// Clicking view details opens the chart-visualizer.
const viewDetailsBtn = document.getElementById('view-details-btn');
viewDetailsBtn.addEventListener('click', function() {
    const savedMunicipalityName = document.querySelector('.stat-name-specific').textContent;
    
    let savedMunicipalityCode = null;

    Object.values(selectedData).forEach(element => {
        if (element.name === savedMunicipalityName) {
            savedMunicipalityCode = element.code;
        }
    });

    if (savedMunicipalityName && savedMunicipalityCode) {
        localStorage.setItem('selectedMunicipality', savedMunicipalityName);
        localStorage.setItem('selectedMunicipalityCode', savedMunicipalityCode);
        window.location.href = '../html/chart-visualizer.html';
    }
  });

getData();